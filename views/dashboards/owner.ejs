<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MediCare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
   <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      overflow-x: hidden;
    }

    .sidebar {
      min-height: 100vh;
      background-color: #f8f9fa;
      padding-top: 1rem;
      position: fixed;
    }

    .sidebar a {
      display: block;
      padding: 10px 15px;
      color: #000;
      text-decoration: none;
    }
  
  .custom-delete-btn {
    background-color: white;
    color: red;
    border: 1px solid red;
    transition: all 0.3s ease;
  }

  .custom-delete-btn:hover {
    background-color: red;
    color: white;
  }

    .sidebar a:hover {
      background-color: #e9ecef;
    }

    .content-section {
  padding: 20px;
}

@media (min-width: 768px) {
  .content-section {
    margin-left: 16.666667%;
  }
}

    .offcanvas-body a {
      margin-bottom: 10px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }
    .navbar{
      background-color: #e9ecef !important;
    }

    @media (max-width: 768px) {
    .card {
      padding: 1rem !important;
      margin-bottom: 1rem;
    }

    .section h3 {
      font-size: 1.25rem;
      margin-top: 1rem;
    }

    .form-label {
      font-size: 0.9rem;
    }

    .btn {
      width: 100%;
    }
  }

  .section {
    margin-bottom: 2rem;
  }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-white px-3 sticky-top">
    <div class="d-flex align-items-center">
      <button class="btn d-md-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
        <i class="fas fa-bars text-light"></i>
      </button>
      <svg class="h-8 w-8 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z"/>
                        </svg>
      <a class="navbar-brand fw-bold text-dark" href="/">MediCare</a>
    </div>
    <a class="nav-link fw-bold text-dark" href="/auth/logout">Log Out</a>
  </nav>

  <!-- Sidebar for large screens -->
  <div class="container-fluid">
    <div class="row">
      <nav class="col-md-3 col-lg-2 d-none d-md-block sidebar">
        <a href="#" data-section="home"><i class="fas fa-house"></i> Home</a>
<a href="#" data-section="allDoctors"><i class="fas fa-user-doctor"></i> All Doctors</a>
<a href="#" data-section="bookings"><i class="fas fa-book"></i> Booking Request</a>
<a href="#" data-section="clinic"><i class="fas fa-clinic-medical"></i> Manage Your Clinic</a>
<a href="#" data-section="addDoctor"><i class="fas fa-user-plus"></i> Add Doctor</a>
<a href="#" data-section="status"><i class="fas fa-clipboard-check"></i> Approval Status</a>

      </nav>

      <!-- Content area -->
      <main class="col-md-9 ms-sm-auto col-lg-10 content-section">
        <section id="home" class="section active">
  <div class="card shadow" style="background-color: #d4edda; border-left: 5px solid #28a745;">
    <div class="card-body">
      <h3 class="card-title text-success">Welcome to MediCare</h3>
      <p class="card-text">This is your dashboard. You can Manage your clinic here.</p>
      <p class="card-text"><strong>Total Doctors:</strong> <%= totalDoctors %></p>
      <p class="card-text">These are the doctors you‚Äôve added to the platform.</p>
    </div>
  </div>
</section>



        <section id="allDoctors" class="section mt-4">
  <h3 class="mb-3">Approved Doctors</h3>

  <% if (approvedDoctors.length > 0) { %>
    <div class="row">
      <% approvedDoctors.forEach(doctor => { %>
        <div class="col-md-4 col-sm-6 mb-4">
          <div class="card h-100 shadow-sm rounded">
            <% if (doctor.photo) { %>
              <img src="<%= doctor.photo %>" class="card-img-top" alt="Doctor Photo" style="height: 200px; object-fit: cover;">
            <% } else { %>
              <img src="/images/default-doctor.jpg" class="card-img-top" alt="Default Photo" style="height: 200px; object-fit: cover;">
            <% } %>
            <div class="card-body">
              <h5 class="card-title"><%= doctor.name %></h5>
              <p class="card-text"><strong>Reg No:</strong> <%= doctor.registrationNumber %></p>
              <p class="card-text"><strong>Degree:</strong> <%= doctor.degree %></p>
              <p class="card-text"><strong>Specialization:</strong> <%= doctor.specialization %></p>
              <p class="card-text"><strong>Clinic:</strong> <%= doctor.clinicName %>, <%= doctor.clinicAddress %></p>
              <p class="card-text"><strong>Contact:</strong> <%= doctor.clinicContact %></p>
             <p><strong>Available Dates:</strong> <%= doctor.availableDates.join(", ") %></p>
<p class="card-text"><strong>Available Slot:</strong>
  <% if (doctor.availableSlots && doctor.availableSlots.length > 0) { 
      const uniqueSlots = [...new Set(doctor.availableSlots)];
      uniqueSlots.forEach((slot, index) => {
        const parts = slot.split(" ");
        const timeSlot = parts.slice(-3).join(" ");
  %>
    <%= timeSlot %><%= index < uniqueSlots.length - 1 ? ", " : "" %>
  <% }); 
  } else { %>
    Not set
  <% } %>
</p>







              <div class="d-flex justify-content-between mt-3">
                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal-<%= doctor._id %>">
                    Edit
                </button>


                <form action="/doctors/<%= doctor._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure?')">
    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
  </form>
              </div>
            </div>
          </div>
          <!-- Edit Modal -->
<!-- Edit Modal -->
<div class="modal fade" id="editModal-<%= doctor._id %>" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <form action="/doctors/<%= doctor._id %>?_method=PUT" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Update Availability</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Clinic Contact</label>
            <input type="text" name="clinicContact" class="form-control" value="<%= doctor.clinicContact %>" required>
          </div>
          
          <div class="mb-3">
  <label>Fees (in ‚Çπ)</label>
  <input type="number" name="fees" class="form-control" value="<%= doctor.fees %>" required>
</div>

<div class="mb-3">
  <label>Experience (in years)</label>
  <input type="number" name="experience" class="form-control" value="<%= doctor.experience %>" required>
</div>

          <div class="mb-3">
            <label for="availableDate">Available Dates *</label>
<input 
  type="text"
  id="availableDate"
  name="availableDate"
  class="form-control"
  value="<%= doctor.availableDates ? doctor.availableDates.join(',') : '' %>">


          </div>

          <div class="mb-3">
  <label class="form-label">Available Slot</label>
  <div class="d-flex gap-2">
    <input type="time" name="slotFrom" class="form-control"
  value="<%= doctor.availableSlots[0]?.split(' - ')[0] || '' %>">
    <span class="fw-bold">to</span>
    <input type="time" name="slotTo" class="form-control"
  value="<%= doctor.availableSlots[0]?.split(' - ')[1] || '' %>">
  </div>
</div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <script>
  flatpickr("#availableDate", {
    mode: "multiple",
    dateFormat: "Y-m-d",
    defaultDate: "<%= doctor.availableDates ? doctor.availableDates.join(',') : '' %>".split(','),
  });
</script>





        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p>No approved doctors yet.</p>
  <% } %>
</section>






        <section id="bookings" class="section container mt-4">
  <h3 class="mb-3">Booking Requests</h3>
  <p>All booking requests made by patients.</p>

  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Patient Name</th>
          <th>Email</th>
          <th>Doctor</th>
          <th>Booking Date</th>
          <th>Booked On</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% bookings.forEach((booking, index) => { %>
          <tr>
            <td><%= index + 1 %></td>
            <td><%= booking.user?.name || "N/A" %></td>
            <td><%= booking.user?.email || "N/A" %></td>
            <td><%= booking.doctor?.name || "N/A" %></td>
            <!-- Format booking date -->
            <td><%= new Date(booking.date).toLocaleDateString("en-IN", { day: '2-digit', month: 'short', year: 'numeric' }) %></td>
            <!-- Show when user booked (createdAt) -->
            <td><%= new Date(booking.createdAt).toLocaleDateString("en-IN", { day: '2-digit', month: 'short', year: 'numeric' }) %></td>
            <td>
              <form method="POST" action="/owner/booking/<%= booking._id %>/delete">
                <button class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this booking?')">Delete</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>




        

        <section id="clinic" class="section"> 
  <h3>Manage Your Clinic</h3>
  <form action="/owner/update-clinic" method="POST">
    <div class="mb-3">
      <label class="form-label">Clinic Name</label>
      <input type="text" name="clinicName" class="form-control" required value="<%= doctors[0]?.clinicName || '' %>">

    </div>
    <div class="mb-3">
      <label class="form-label">Location</label>
      <input type="text" name="clinicAddress" class="form-control" required value="<%= doctors[0]?.clinicAddress || '' %>">
    </div>
    <div class="mb-3">
      <label class="form-label">Contact</label>
      <input type="text" name="clinicContact" class="form-control" value="<%= doctors[0]?.clinicContact || '' %>">
    </div>
    <button type="submit" class="btn btn-primary">Update Clinic</button>
  </form>
</section>

        <section id="addDoctor" class="section">
  <h3>Add Doctor</h3>
  <form action="/doctors/add" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
    
    <div class="mb-3">
      <label class="form-label">Doctor Name</label>
      <input type="text" name="name" class="form-control" required>
      <div class="invalid-feedback">Please enter doctor name.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Degree</label>
      <input type="text" name="degree" class="form-control" required>
      <div class="invalid-feedback">Please enter degree.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Doctor Registration Number</label>
      <input type="text" name="registrationNumber" class="form-control" required>
      <div class="invalid-feedback">Please enter registration number.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Specialization</label>
      <input type="text" name="specialization" class="form-control" required>
      <div class="invalid-feedback">Please enter specialization.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Doctor Photo</label>
      <input type="file" name="photo" class="form-control" accept="image/*" required>
      <div class="invalid-feedback">Please upload a photo.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Clinic Name</label>
      <input type="text" name="clinicName" class="form-control" required>
      <div class="invalid-feedback">Please enter clinic name.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Clinic Address</label>
      <input type="text" name="clinicAddress" class="form-control" required>
      <div class="invalid-feedback">Please enter clinic address.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Clinic Contact</label>
      <input type="text" name="clinicContact" class="form-control" required>
      <div class="invalid-feedback">Please enter clinic contact.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Fees (INR)</label>
      <input type="number" name="fees" class="form-control" required>
      <div class="invalid-feedback">Please enter doctor fees.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Experience (in years)</label>
      <input type="number" name="experience" class="form-control" required>
      <div class="invalid-feedback">Please enter experience.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Available Date</label>
      <input type="text" id="availableDate" name="availableDate" class="form-control" placeholder="Select Date" required>
      <div class="invalid-feedback">Please select available date.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Available Slot</label>
      <div class="d-flex gap-2">
        <input type="time" name="slotFrom" class="form-control" required>
        <span class="fw-bold">to</span>
        <input type="time" name="slotTo" class="form-control" required>
      </div>
      <div class="invalid-feedback">Please select time slot.</div>
    </div>

    <button type="submit" class="btn btn-success">Submit for Approval</button>
  </form>
</section>




        <section id="status" class="section">
  <h3>Doctor Approval Status</h3>
  <% if (doctors.length === 0) { %>
    <p>No doctors added yet.</p>
  <% } else { %>
    <% doctors.forEach(doc => { %>
      <div class="card mb-3 mt-5 p-3 shadow-sm">
        <h5><%= doc.name %> (<%= doc.specialization %>)</h5>
        <p>Degree: <%= doc.degree %></p>
        <p>Clinic: <%= doc.clinicName %>, <%= doc.clinicAddress %></p>
        <p>Contact: <%= doc.clinicContact %></p>
        <p>Status:
          <% if (doc.isApproved === true) { %>
            <span class="badge bg-success">Approved</span> by <%= doc.approvedBy?.username || 'Admin' %>
          <% } else if (doc.isApproved === false) { %>
            <span class="badge bg-danger">Rejected</span> by <%= doc.approvedBy?.username || 'Admin' %>
            <% if (doc.rejectionReason) { %>
              <br><strong>Reason:</strong> <%= doc.rejectionReason %>
            <% } %>
            <!-- Resubmit & Edit Button -->
            <span class="badge bg-warning text-dark mt-2" role="button" data-bs-toggle="modal" data-bs-target="#resubmitModal-<%= doc._id %>">Edit & Resubmit</span>

          <% } else { %>
            <span class="badge bg-warning text-dark">Pending</span>
          <% } %>
        </p>
        <br>
        <!-- Delete Button -->
        <form action="/doctors/<%= doc._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure to delete?')">
          <button class="btn btn-sm custom-delete-btn">Delete</button>
        </form>
      </div>

      <!-- Edit & Resubmit Modal -->
      <div class="modal fade" id="resubmitModal-<%= doc._id %>" tabindex="-1" aria-labelledby="resubmitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
          <div class="modal-content">
            <form action="/doctors/<%= doc._id %>/resubmit?_method=PUT" method="POST" enctype="multipart/form-data">

              <div class="modal-header">
                <h5 class="modal-title">Edit & Resubmit Doctor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">

                <div class="mb-2">
                  <label class="form-label">Doctor Name</label>
                  <input type="text" name="name" class="form-control" value="<%= doc.name %>" required>
                </div>
                <div class="mb-2">
                  <label class="form-label">Degree</label>
                  <input type="text" name="degree" class="form-control" value="<%= doc.degree %>">
                </div>
                <div class="mb-2">
                  <label class="form-label">Registration Number</label>
                  <input type="text" name="registrationNumber" class="form-control" value="<%= doc.registrationNumber %>">
                </div>
                <div class="mb-2">
                  <label class="form-label">Specialization</label>
                  <input type="text" name="specialization" class="form-control" value="<%= doc.specialization %>">
                </div>
                <div class="mb-2">
  <label class="form-label">Doctor Photo</label>
  <% if (doc.photo) { %>
    <img src="<%= doc.photo %>" alt="Current Photo" class="img-fluid mb-2 rounded" style="max-height: 150px;">
  <% } %>
  <input type="file" name="photo" class="form-control" accept="image/*">
</div>

                <div class="mb-2">
                  <label class="form-label">Clinic Name</label>
                  <input type="text" name="clinicName" class="form-control" value="<%= doc.clinicName %>">
                </div>
                <div class="mb-2">
                  <label class="form-label">Clinic Address</label>
                  <input type="text" name="clinicAddress" class="form-control" value="<%= doc.clinicAddress %>">
                </div>
                <div class="mb-2">
                  <label class="form-label">Clinic Contact</label>
                  <input type="text" name="clinicContact" class="form-control" value="<%= doc.clinicContact %>">
                </div>
                <div class="modal-footer">
                <button type="submit" class="btn btn-success">Resubmit</button>
              </div>
      
              </div>

            </form>
          </div>
        </div>
      </div>
    <% }) %>
  <% } %>
</section>

<script>
  document.querySelectorAll(".availableDatePicker").forEach(input => {
    flatpickr(input, {
      mode: "multiple",
      dateFormat: "Y-m-d"
    });
  });
</script>


      </main>
    </div>
  </div>

  <!-- Offcanvas sidebar for mobile -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Dashboard</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <a class="btn btn-light w-100" href="#" data-section="home" data-bs-dismiss="offcanvas">üè† Home</a>
      <a class="btn btn-light w-100" href="#" data-section="allDoctors" data-bs-dismiss="offcanvas">All Doctors</a>
      <a class="btn btn-light w-100" href="#" data-section="bookings" data-bs-dismiss="offcanvas">üìñ Booking Request</a>
      <a class="btn btn-light w-100" href="#" data-section="clinic" data-bs-dismiss="offcanvas">üè• Clinic Info</a>
      <a class="btn btn-light w-100" href="#" data-section="addDoctor" data-bs-dismiss="offcanvas">Add Doctor</a>
      <a class="btn btn-light w-100" href="#" data-section="status" data-bs-dismiss="offcanvas">Approvals Status</a>
    </div>
  </div>

  <!-- Section Toggle Script -->
  <script>
    const links = document.querySelectorAll('[data-section]');
    const sections = document.querySelectorAll('.section');

    links.forEach(link => {
      link.addEventListener('click', () => {
        const target = link.getAttribute('data-section');
        sections.forEach(sec => sec.classList.remove('active'));
        document.getElementById(target).classList.add('active');
      });
    });

    flatpickr("#availableDate", {
  mode: "multiple",
  dateFormat: "Y-m-d",
  defaultDate: [], // default selected dates if any
  wrap: false,
  allowInput: true,
  minDate: "today" // optional: block past dates
});
// Bootstrap 5 form validation
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', e => {
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();

  </script>

</body>
</html>
